# --- Build stage ----------------------------------------------------
FROM node:12-buster AS build
WORKDIR /app

# Fix outdated Debian 'buster' repositories
RUN sed -i 's|deb.debian.org|archive.debian.org|g' /etc/apt/sources.list && \
    sed -i 's|security.debian.org|archive.debian.org|g' /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid

# Install system packages required for node-sass
RUN apt-get update && \
    apt-get install -y --no-install-recommends python2 make g++ && \
    ln -sf /usr/bin/python2 /usr/bin/python

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# --- Runtime stage --------------------------------------------------
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80