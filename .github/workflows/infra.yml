name: Infrastructure Pipeline

on:
  push:
    paths:
      - "infra/terraform/**"
      - "infra/ansible/**"
  workflow_dispatch:

jobs:

  terraform-plan:
    name: Terraform Plan (Drift Check)
    runs-on: ubuntu-latest
    continue-on-error: true   # prevent exit 2 from failing the job

    outputs:
      drift: ${{ steps.check.outputs.drift }}
      plan_exit_code: ${{ steps.tf_plan.outputs.exit_code }}

    env:
      TF_VAR_key_name: ${{ secrets.TF_VAR_key_name }}
      TF_VAR_public_key: ${{ secrets.TF_VAR_public_key }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Init Terraform
        working-directory: infra/terraform
        run: terraform init -input=false

      - name: Refresh Terraform State
        working-directory: infra/terraform
        run: terraform refresh -lock-timeout=300s

      - name: Run Terraform Plan
        id: tf_plan
        working-directory: infra/terraform
        run: |
          set +e
          terraform plan -detailed-exitcode -lock-timeout=300s -out=tfplan
          exitcode=$?
          echo "exit_code=$exitcode" >> $GITHUB_OUTPUT
          exit 0    # continue job no matter what

      - name: Detect Drift
        id: check
        run: |
          if [ "${{ steps.tf_plan.outputs.exit_code }}" == "2" ]; then
            echo "drift=true" >> $GITHUB_OUTPUT
          else
            echo "drift=false" >> $GITHUB_OUTPUT
          fi

  email-alert:
    name: Send Drift Email
    needs: terraform-plan
    if: needs.terraform-plan.outputs.drift == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Install msmtp
        run: |
          sudo apt-get update
          sudo apt-get install -y msmtp

      - name: Configure msmtp
        run: |
          cat <<EOF > ~/.msmtprc
          defaults
          auth           on
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          logfile        ~/.msmtp.log

          account        mailer
          host           ${SMTP_HOST}
          port           ${SMTP_PORT}
          from           ${SMTP_USER}
          user           ${SMTP_USER}
          password       ${SMTP_PASS}

          account default : mailer
          EOF

          chmod 600 ~/.msmtprc

      - name: Send Notification Email
        run: |
          echo "üö® Terraform Infrastructure Drift Detected in your HNG Stage 6 Environment." \
          | msmtp -a default ${{ secrets.ALERT_EMAIL }}

        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}

  manual-approval:
    name: Manual Approval Gate
    needs: [terraform-plan, email-alert]
    if: needs.terraform-plan.outputs.drift == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Waiting for approval
        run: echo "‚è≥ Waiting for manual approval before Terraform Apply..."

  terraform-apply:
    name: Terraform Apply
    needs: [terraform-plan, manual-approval]
    runs-on: ubuntu-latest

    # Auto-apply if no drift, or apply after approval if drift exists
    if: |
      needs.terraform-plan.outputs.drift == 'false' ||
      (needs.terraform-plan.outputs.drift == 'true' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Init Terraform
        working-directory: infra/terraform
        run: terraform init -input=false

      - name: Terraform Apply
        working-directory: infra/terraform
        run: terraform apply -auto-approve tfplan
